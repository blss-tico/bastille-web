{{define "content"}}
  <div class="card">
    {{$parentContext := .}} 
    {{range .Data.Commands}}
      {{if eq .Command $.CommandName}}
        <div class="card-title">{{.Command}}</div>
        <div class="card-description">{{.Description}}</div>
        <div class="card-content">
          <form id="{{$.CommandName}}-form" class="card-form">
            <label>OPTIONS:</label><br />
            {{range .Options}}
              <input type="checkbox" name="options_{{.Lflag}}" value="{{.Sflag}}" />
              <label for="{{.Lflag}}">{{.Lflag}}</label>
              &nbsp;
            {{end}}
            <br /><br />
            {{range .Fields}}
              <label>{{.}}</label><br />
              <input type="text" name="{{.}}" />
              <br /><br />
            {{end}}
            <button class="btn-card-submit" onclick="bootstrapSubmit(event)">Submit</button>          
          </form>
        </div>
        <br />
        <div class="card-help">
          <h3>Help</h3>
          <p>{{.Help}}</p>
          <div class="card-help-options">
            {{range .Options}}
              <p>&nbsp;&nbsp;{{.Sflag}}&nbsp;|&nbsp;{{.Lflag}}&nbsp;-&nbsp;{{.Text}}</p>
            {{end}}
          </div>
        </div>
      {{end}}
    {{end}}
    <div class="card-results">
      <p id="result" class="card-result"></p>
      <p id="error" class="card-error"></p>
    </div>
  </div>

  <script>
    async function bootstrapSubmit(event) {
      event.preventDefault();

      const name = '{{$.CommandName}}';
      const result = document.getElementById('result');
      const error = document.getElementById('error');
      result.innerText = "";
      error.innerText = ""; 

      const form = document.getElementById(name + '-form');
      const formData = new FormData(form);
      let options = [];
      let formObj = {};
      formData.forEach((value, key) => {
        value = value.trim();

        // options
        if (key.indexOf('options_') != -1) {
          options.push(value);
          return;
        }

        // release or template
        if (key == "RELEASE|TEMPLATE") {
          // bsd flavors
          const releaseRegex = /^\d+|(\.\d+)|-/;
          if (releaseRegex.test(value)) {
            formObj[key] = value;
            return;
          }
          
          // templates https
          if (value.includes("https://gitlab.com/bastillebsd-templates/")) {
            formObj[key] = value;
            return;
          }
          
          // templates git@
          if (value.includes("git@")) {
            formObj[key] = value;
            return;
          }
          
          // linux flavors
          const rt = [
            "ubuntu_bionic", "bionic", "ubuntu-bionic",
            "ubuntu_focal","focal", "ubuntu-focal", 
            "ubuntu_jammy","jammy", "ubuntu-jammy",
            "ubuntu_noble","noble", "ubuntu-noble",
            "debian_buster", "buster", "debian-buster",
            "debian_bullseye", "bullseye", "debian-bullseye",
            "debian_bookworm", "bookworm", "debian-bookworm"
          ];
          if (rt.indexOf(value) != -1) { 
            formObj[key] = value;
            return;
          }

          error.innerText = "[Error]: RELEASE|TEMPLATE is incorrect, see help;";
        }
        
        // update or archtecture
        if (key == "update|arch") {
          const updatearchRegex = /(update|--i386|--32bit)$/;
          if (updatearchRegex.test(value) || value == "") { 
            formObj[key] = value;
          } else { 
            error.innerText = "[Error]: update, --i386, --32bit are the valid options for this field;"; 
          }
        }
      });
      
      if (error.innerText != "") { return; }

      formObj['options'] = options.join(' ').trimEnd();
      const formJson = JSON.stringify(formObj);
      
      result.innerText = 'send -> bastille ' + name;
      
      const response = await sendHttpRequest(name, formJson);
      if (response.code == 200) {
        error.innerText = "";
        result.innerText = response.data.msg;
      } else {
        result.innerText = "";
        error.innerText = response.error;
      }
    }
  </script>
{{end}}
