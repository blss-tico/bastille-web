{{define "content"}}
  <div>
    <h3 class="ttl-home-host-info">Host Info</h3>
    {{if .SysInfo}}
      <table class="tbl-home-host-info">
        <tbody>
          <tr>
            <td>HOSTNAME</td>
            <td><strong>{{ .SysInfo.Hostname}}</strong></td> 
          </tr>
          <tr>
            <td>PLATFORM</td>
            <td><strong>{{ .SysInfo.Platform}}</strong></td>
          </tr>  
          <tr>
            <td>RELEASE</td>
            <td><strong>{{ .SysInfo.Osrelease}}</strong></td>
          </tr>
          <tr>
            <td>ARCHTECTURE</td>
            <td><strong>{{ .SysInfo.Arch}}</strong></td>
          </tr>
          <tr>
            <td>TOTAL MEMORY</td>
            <td><strong>{{ .SysInfo.Totalmemory}} (Gb)</strong></td>
          </tr>
          <tr>
            <td>BASTILLE VERSION</td>
            <td><strong>{{ .SysInfo.BastilleVersion}}</strong></td>
          </tr>
        </tbody>
      </table>
    {{end}}
  </div>

  <br />
  
  <div class="div-home-list-jails">
    {{if .JailsData}}
      <h3 class="ttl-home-list-jails">Bastille Jails</h3>
      <table class="tbl-home-list-jails">
        <thead>
          <tr>
            <th>JID</th>
            <th>BOOT</th>
            <th>PRIO</th>
            <th>STATE</th>
            <th>IP ADDRESS</th>
            <th>PUBLISHED PORTS</th>
            <th>HOSTNAME</th>
            <th>RELEASE</th>
            <th class="tbl-home-th-path">PATH</th>
            <th>ACTION</th>
            <th>#</th>
          </tr>
        </thead>
        <tbody>
          {{range $index, $element := .JailsData}}
            <tr class='{{if eq .State "Up"}}tbl-home-list-jails-up{{else}}tbl-home-list-jails-down{{end}}'>
              <td data-label="JID">{{ $element.Jid}}</td>
              <td data-label="BOOT">{{ $element.Boot}}</td>
              <td data-label="PRIO">{{ $element.Prio}}</td>
              <td data-label="STATE">{{ $element.State}}</td>
              <td data-label="IP">{{ $element.Ip}}</td>
              <td data-label="PUBLISHED">{{ $element.Published}}</td>
              <td data-label="HOSTNAME">{{ $element.Hostname}}</td>
              <td data-label="RELEASE">{{ $element.Release}}</td>
              <td data-label="PATH" class="tbl-home-td-path">{{ $element.Path}}</td>
              <td data-label="ACTION" class="tbl-home-td-btns">
                <button 
                  class="btn-home-start-jail" 
                  onclick="startJail('{{$element.Hostname}}', '{{$index}}')" 
                  {{if eq $element.State "Up" }}disabled{{end}}
                >
                  START
                </button>
                <button 
                  class="btn-home-stop-jail" 
                  onclick="stopJail('{{$element.Hostname}}', '{{$index}}')" 
                  {{if eq $element.State "Down" }}disabled{{end}}
                >
                  STOP
                </button>
              </td>
              <td data-label="LOADER" class="tbl-home-td-loader">
                <div class="loader"></div>
              </td>
            </tr>
          {{end}}
        </tbody>
      </table>
      <dialog class="home-modal" id="homeModal">
        <h3>Error</h3>
        <p class="home-modal-text" id="homeModalText"></p>
        <button class="home-modal-close-btn" onclick="closeModal()">CLOSE</button>
      </dialog>
    {{end}}
  </div>

  <script>
    const timeout = 5000;
    let hmModal = document.getElementById("homeModal");
    let hmModalTxt = document.getElementById("homeModalText");
    let loaderDiv = document.getElementsByClassName("loader");
    let btnsStart = document.getElementsByClassName("btn-home-start-jail");
    let btnsStop = document.getElementsByClassName("btn-home-stop-jail");
    
    hmModal.style.display = 'none';
    hideLoader();

    function redirectUrl() {
      window.location.href = "http://{{.Addr}}/";
    }

    function closeModal() {
      hmModal.style.display = 'none';
      redirectUrl();
    }

    function hideLoader() {
      for (const elem of loaderDiv) { elem.style.display = 'none'; }
    }

    function showLoader() {
      for (const elem of loaderDiv) { elem.style.display = 'block'; }
    }

    function disableButtons() {
      for (const btna of btnsStart) { btna.setAttribute('disabled', ''); }
      for (const btno of btnsStop) { btno.setAttribute('disabled', ''); }
    }

    function enableButtons() {
      for (const btna of btnsStart) { btna.setAttribute('enabled', ''); }
      for (const btno of btnsStop) { btno.setAttribute('enabled', ''); }
    }

    async function startJail(target, idx) {
      disableButtons();
      loaderDiv[idx].style.display = 'block';

      const data = { options: "", target: target, value: "" };
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch('/start', {
          method: 'POST',          
          headers: {
            'Access-Control-Allow-Origin': '*',
            'accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Request-ID': sessionStorage.getItem('id')
          },
          body: JSON.stringify(data),
          signal: controller.signal
        });
        
        clearTimeout(id);

        if (!response.ok) {        
          const error = await response.text();
          throw new Error(error);
        }
        
        hideLoader();
        enableButtons();
        redirectUrl();
      } catch (error) {
        if (error.name === 'AbortError') { hmModalTxt.innerText = 'Fetch request timed out.'; } 
        else { hmModalTxt.innerText = error; }

        hmModal.style.display = 'block';
        return;
      }
    }

    async function stopJail(target, idx) {
      disableButtons();
      loaderDiv[idx].style.display = 'block';

      const data = { options: "", target: target };
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch('/stop', {
          method: 'POST',
          headers: {
            'access-control-allow-origin': '*',
            'accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Request-ID': sessionStorage.getItem('id')
          },
          body: JSON.stringify(data),
          signal: controller.signal
        });
        
        clearTimeout(id);

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error);
        }

        hideLoader();
        enableButtons();
        redirectUrl();
      } catch (error) {
        if (error.name === 'AbortError') { hmModalTxt.innerText = 'Fetch request timed out.'; } 
        else { hmModalTxt.innerText = error; }

        hmModal.style.display = 'block';
        return;
      }
    }
  </script>
{{end}}
